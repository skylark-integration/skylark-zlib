/**
 * skylark-zlib - A version of zlib.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-zlib/
 * @license MIT
 */
define(["./zlib","./Heap","./BitStream"],function(e,t,r){var n,a=function(e,t){this.compressionType=a.CompressionType.DYNAMIC,this.lazy=0,this.freqsLitLen,this.freqsDist,this.input=e instanceof Array?new Uint8Array(e):e,this.output,this.op=0,t&&(t.lazy&&(this.lazy=t.lazy),"number"==typeof t.compressionType&&(this.compressionType=t.compressionType),t.outputBuffer&&(this.output=t.outputBuffer instanceof Array?new Uint8Array(t.outputBuffer):t.outputBuffer),"number"==typeof t.outputIndex&&(this.op=t.outputIndex)),this.output||(this.output=new Uint8Array(32768))};return a.CompressionType={NONE:0,FIXED:1,DYNAMIC:2,RESERVED:3},a.Lz77MinLength=3,a.Lz77MaxLength=258,a.WindowSize=32768,a.MaxCodeLength=16,a.HUFMAX=286,a.FixedHuffmanTable=function(){var e,t=[];for(e=0;e<288;e++)switch(!0){case e<=143:t.push([e+48,8]);break;case e<=255:t.push([e-144+400,9]);break;case e<=279:t.push([e-256+0,7]);break;case e<=287:t.push([e-280+192,8]);break;default:throw"invalid literal: "+e}return t}(),a.prototype.compress=function(){var e,t,r,n=this.input;switch(this.compressionType){case a.CompressionType.NONE:for(t=0,r=n.length;t<r;)t+=(e=n.subarray(t,t+65535)).length,this.makeNocompressBlock(e,t===r);break;case a.CompressionType.FIXED:this.output=this.makeFixedHuffmanBlock(n,!0),this.op=this.output.length;break;case a.CompressionType.DYNAMIC:this.output=this.makeDynamicHuffmanBlock(n,!0),this.op=this.output.length;break;default:throw"invalid compression type"}return this.output},a.prototype.makeNocompressBlock=function(e,t){var r,n,s,i,o=this.output,u=this.op;for(o=new Uint8Array(this.output.buffer);o.length<=u+e.length+5;)o=new Uint8Array(o.length<<1);return o.set(this.output),r=t?1:0,n=a.CompressionType.NONE,o[u++]=r|n<<1,i=65536+~(s=e.length)&65535,o[u++]=255&s,o[u++]=s>>>8&255,o[u++]=255&i,o[u++]=i>>>8&255,o.set(e,u),u+=e.length,o=o.subarray(0,u),this.op=u,this.output=o,o},a.prototype.makeFixedHuffmanBlock=function(e,t){var n,s,i,o=new r(new Uint8Array(this.output.buffer),this.op);return n=t?1:0,s=a.CompressionType.FIXED,o.writeBits(n,1,!0),o.writeBits(s,2,!0),i=this.lz77(e),this.fixedHuffman(i,o),o.finish()},a.prototype.makeDynamicHuffmanBlock=function(e,t){var n,s,i,o,u,h,c,f,p,l,y,g,w,b,k,m,L,d=new r(new Uint8Array(this.output.buffer),this.op),A=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],B=new Array(19);for(n=t?1:0,s=a.CompressionType.DYNAMIC,d.writeBits(n,1,!0),d.writeBits(s,2,!0),i=this.lz77(e),c=this.getLengths_(this.freqsLitLen,15),f=this.getCodesFromLengths_(c),p=this.getLengths_(this.freqsDist,7),l=this.getCodesFromLengths_(p),o=286;o>257&&0===c[o-1];o--);for(u=30;u>1&&0===p[u-1];u--);for(y=this.getTreeSymbols_(o,c,u,p),g=this.getLengths_(y.freqs,7),m=0;m<19;m++)B[m]=g[A[m]];for(h=19;h>4&&0===B[h-1];h--);for(w=this.getCodesFromLengths_(g),d.writeBits(o-257,5,!0),d.writeBits(u-1,5,!0),d.writeBits(h-4,4,!0),m=0;m<h;m++)d.writeBits(B[m],3,!0);for(m=0,L=y.codes.length;m<L;m++)if(b=y.codes[m],d.writeBits(w[b],g[b],!0),b>=16){switch(m++,b){case 16:k=2;break;case 17:k=3;break;case 18:k=7;break;default:throw"invalid code: "+b}d.writeBits(y.codes[m],k,!0)}return this.dynamicHuffman(i,[f,c],[l,p],d),d.finish()},a.prototype.dynamicHuffman=function(e,t,r,n){var a,s,i,o,u,h,c,f;for(u=t[0],h=t[1],c=r[0],f=r[1],a=0,s=e.length;a<s;++a)if(i=e[a],n.writeBits(u[i],h[i],!0),i>256)n.writeBits(e[++a],e[++a],!0),o=e[++a],n.writeBits(c[o],f[o],!0),n.writeBits(e[++a],e[++a],!0);else if(256===i)break;return n},a.prototype.fixedHuffman=function(e,t){var n,s,i;for(n=0,s=e.length;n<s;n++)if(i=e[n],r.prototype.writeBits.apply(t,a.FixedHuffmanTable[i]),i>256)t.writeBits(e[++n],e[++n],!0),t.writeBits(e[++n],5),t.writeBits(e[++n],e[++n],!0);else if(256===i)break;return t},a.Lz77Match=function(e,t){this.length=e,this.backwardDistance=t},a.Lz77Match.LengthCodeTable=(n=function(){var e,t,r=[];for(e=3;e<=258;e++)t=n(e),r[e]=t[2]<<24|t[1]<<16|t[0];function n(e){switch(!0){case 3===e:return[257,e-3,0];case 4===e:return[258,e-4,0];case 5===e:return[259,e-5,0];case 6===e:return[260,e-6,0];case 7===e:return[261,e-7,0];case 8===e:return[262,e-8,0];case 9===e:return[263,e-9,0];case 10===e:return[264,e-10,0];case e<=12:return[265,e-11,1];case e<=14:return[266,e-13,1];case e<=16:return[267,e-15,1];case e<=18:return[268,e-17,1];case e<=22:return[269,e-19,2];case e<=26:return[270,e-23,2];case e<=30:return[271,e-27,2];case e<=34:return[272,e-31,2];case e<=42:return[273,e-35,3];case e<=50:return[274,e-43,3];case e<=58:return[275,e-51,3];case e<=66:return[276,e-59,3];case e<=82:return[277,e-67,4];case e<=98:return[278,e-83,4];case e<=114:return[279,e-99,4];case e<=130:return[280,e-115,4];case e<=162:return[281,e-131,5];case e<=194:return[282,e-163,5];case e<=226:return[283,e-195,5];case e<=257:return[284,e-227,5];case 258===e:return[285,e-258,0];default:throw"invalid length: "+e}}return r}(),new Uint32Array(n)),a.Lz77Match.prototype.getDistanceCode_=function(e){var t;switch(!0){case 1===e:t=[0,e-1,0];break;case 2===e:t=[1,e-2,0];break;case 3===e:t=[2,e-3,0];break;case 4===e:t=[3,e-4,0];break;case e<=6:t=[4,e-5,1];break;case e<=8:t=[5,e-7,1];break;case e<=12:t=[6,e-9,2];break;case e<=16:t=[7,e-13,2];break;case e<=24:t=[8,e-17,3];break;case e<=32:t=[9,e-25,3];break;case e<=48:t=[10,e-33,4];break;case e<=64:t=[11,e-49,4];break;case e<=96:t=[12,e-65,5];break;case e<=128:t=[13,e-97,5];break;case e<=192:t=[14,e-129,6];break;case e<=256:t=[15,e-193,6];break;case e<=384:t=[16,e-257,7];break;case e<=512:t=[17,e-385,7];break;case e<=768:t=[18,e-513,8];break;case e<=1024:t=[19,e-769,8];break;case e<=1536:t=[20,e-1025,9];break;case e<=2048:t=[21,e-1537,9];break;case e<=3072:t=[22,e-2049,10];break;case e<=4096:t=[23,e-3073,10];break;case e<=6144:t=[24,e-4097,11];break;case e<=8192:t=[25,e-6145,11];break;case e<=12288:t=[26,e-8193,12];break;case e<=16384:t=[27,e-12289,12];break;case e<=24576:t=[28,e-16385,13];break;case e<=32768:t=[29,e-24577,13];break;default:throw"invalid distance"}return t},a.Lz77Match.prototype.toLz77Array=function(){var e,t=this.length,r=this.backwardDistance,n=[],s=0;return e=a.Lz77Match.LengthCodeTable[t],n[s++]=65535&e,n[s++]=e>>16&255,n[s++]=e>>24,e=this.getDistanceCode_(r),n[s++]=e[0],n[s++]=e[1],n[s++]=e[2],n},a.prototype.lz77=function(e){var t,r,n,s,i,o,u,h,c,f={},p=a.WindowSize,l=new Uint16Array(2*e.length),y=0,g=0,w=new Uint32Array(286),b=new Uint32Array(30),k=this.lazy;function m(e,t){var r,n,a=e.toLz77Array();for(r=0,n=a.length;r<n;++r)l[y++]=a[r];w[a[0]]++,b[a[3]]++,g=e.length+t-1,h=null}for(w[256]=1,t=0,r=e.length;t<r;++t){for(i=0,n=0,s=a.Lz77MinLength;n<s&&t+n!==r;++n)i=i<<8|e[t+n];if(void 0===f[i]&&(f[i]=[]),o=f[i],g-- >0)o.push(t);else{for(;o.length>0&&t-o[0]>p;)o.shift();if(t+a.Lz77MinLength>=r){for(h&&m(h,-1),n=0,s=r-t;n<s;++n)c=e[t+n],l[y++]=c,++w[c];break}o.length>0?(u=this.searchLongestMatch_(e,t,o),h?h.length<u.length?(c=e[t-1],l[y++]=c,++w[c],m(u,0)):m(h,-1):u.length<k?h=u:m(u,0)):h?m(h,-1):(c=e[t],l[y++]=c,++w[c]),o.push(t)}}return l[y++]=256,w[256]++,this.freqsLitLen=w,this.freqsDist=b,l.subarray(0,y)},a.prototype.searchLongestMatch_=function(e,t,r){var n,s,i,o,u,h,c=0,f=e.length;e:for(o=0,h=r.length;o<h;o++){if(n=r[h-o-1],i=a.Lz77MinLength,c>a.Lz77MinLength){for(u=c;u>a.Lz77MinLength;u--)if(e[n+u-1]!==e[t+u-1])continue e;i=c}for(;i<a.Lz77MaxLength&&t+i<f&&e[n+i]===e[t+i];)++i;if(i>c&&(s=n,c=i),i===a.Lz77MaxLength)break}return new a.Lz77Match(c,t-s)},a.prototype.getTreeSymbols_=function(e,t,r,n){var a,s,i,o,u,h,c=new Uint32Array(e+r),f=new Uint32Array(316),p=new Uint8Array(19);for(s=0,a=0;a<e;a++)c[s++]=t[a];for(a=0;a<r;a++)c[s++]=n[a];for(u=0,a=0,o=c.length;a<o;a+=s){for(s=1;a+s<o&&c[a+s]===c[a];++s);if(i=s,0===c[a])if(i<3)for(;i-- >0;)f[u++]=0,p[0]++;else for(;i>0;)(h=i<138?i:138)>i-3&&h<i&&(h=i-3),h<=10?(f[u++]=17,f[u++]=h-3,p[17]++):(f[u++]=18,f[u++]=h-11,p[18]++),i-=h;else if(f[u++]=c[a],p[c[a]]++,--i<3)for(;i-- >0;)f[u++]=c[a],p[c[a]]++;else for(;i>0;)(h=i<6?i:6)>i-3&&h<i&&(h=i-3),f[u++]=16,f[u++]=h-3,p[16]++,i-=h}return{codes:f.subarray(0,u),freqs:p}},a.prototype.getLengths_=function(e,r){var n,s,i,o,u,h=e.length,c=new t(2*a.HUFMAX),f=new Uint8Array(h);for(o=0;o<h;++o)e[o]>0&&c.push(o,e[o]);if(n=new Array(c.length/2),s=new Uint32Array(c.length/2),1===n.length)return f[c.pop().index]=1,f;for(o=0,u=c.length/2;o<u;++o)n[o]=c.pop(),s[o]=n[o].value;for(i=this.reversePackageMerge_(s,s.length,r),o=0,u=n.length;o<u;++o)f[n[o].index]=i[o];return f},a.prototype.reversePackageMerge_=function(e,t,r){var n,a,s,i,o,u=new Uint16Array(r),h=new Uint8Array(r),c=new Uint8Array(t),f=new Array(r),p=new Array(r),l=new Array(r),y=(1<<r)-t,g=1<<r-1;function w(e){var r=p[e][l[e]];r===t?(w(e+1),w(e+1)):--c[r],++l[e]}for(u[r-1]=t,a=0;a<r;++a)y<g?h[a]=0:(h[a]=1,y-=g),y<<=1,u[r-2-a]=(u[r-1-a]/2|0)+t;for(u[0]=h[0],f[0]=new Array(u[0]),p[0]=new Array(u[0]),a=1;a<r;++a)u[a]>2*u[a-1]+h[a]&&(u[a]=2*u[a-1]+h[a]),f[a]=new Array(u[a]),p[a]=new Array(u[a]);for(n=0;n<t;++n)c[n]=r;for(s=0;s<u[r-1];++s)f[r-1][s]=e[s],p[r-1][s]=s;for(n=0;n<r;++n)l[n]=0;for(1===h[r-1]&&(--c[0],++l[r-1]),a=r-2;a>=0;--a){for(n=0,i=0,o=l[a+1],s=0;s<u[a];s++)(i=f[a+1][o]+f[a+1][o+1])>e[n]?(f[a][s]=i,p[a][s]=t,o+=2):(f[a][s]=e[n],p[a][s]=n,++n);l[a]=0,1===h[a]&&w(a)}return c},a.prototype.getCodesFromLengths_=function(e){var t,r,n,s,i=new Uint16Array(e.length),o=[],u=[],h=0;for(t=0,r=e.length;t<r;t++)o[e[t]]=1+(0|o[e[t]]);for(t=1,r=a.MaxCodeLength;t<=r;t++)u[t]=h,h+=0|o[t],h<<=1;for(t=0,r=e.length;t<r;t++)for(h=u[e[t]],u[e[t]]+=1,i[t]=0,n=0,s=e[t];n<s;n++)i[t]=i[t]<<1|1&h,h>>>=1;return i},e.RawDeflate=a});
//# sourceMappingURL=sourcemaps/RawDeflate.js.map
