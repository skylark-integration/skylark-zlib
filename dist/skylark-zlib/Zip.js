/**
 * skylark-zlib - A version of zlib.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-zlib/
 * @license MIT
 */
define(["./zlib","./crc32","./RawDeflate"],function(e,t,o){return Zip=function(e){e=e||{},this.files=[],this.comment=e.comment,this.password},Zip.CompressionMethod={STORE:0,DEFLATE:8},Zip.OperatingSystem={MSDOS:0,UNIX:3,MACINTOSH:7},Zip.Flags={ENCRYPT:1,DESCRIPTOR:8,UTF8:2048},Zip.FileHeaderSignature=[80,75,1,2],Zip.LocalFileHeaderSignature=[80,75,3,4],Zip.CentralDirectorySignature=[80,75,5,6],Zip.prototype.addFile=function(e,o){(o=o||{}).filename;var i,n=e.length,r=0;if(e instanceof Array&&(e=new Uint8Array(e)),"number"!=typeof o.compressionMethod&&(o.compressionMethod=Zip.CompressionMethod.DEFLATE),o.compress)switch(o.compressionMethod){case Zip.CompressionMethod.STORE:break;case Zip.CompressionMethod.DEFLATE:r=t.calc(e),e=this.deflateWithOption(e,o),i=!0;break;default:throw new Error("unknown compression method:"+o.compressionMethod)}this.files.push({buffer:e,option:o,compressed:i,encrypted:!1,size:n,crc32:r})},Zip.prototype.setPassword=function(e){this.password=e},Zip.prototype.compress=function(){var e,o,i,n,r,s,p,a,c,h,l,d,m,f,u,g,Z,y,S,w,F,M,E,b,C,D,O,H=this.files,T=0,A=0;for(b=0,C=H.length;b<C;++b){if(u=(e=H[b]).option.filename?e.option.filename.length:0,g=e.option.extraField?e.option.extraField.length:0,Z=e.option.comment?e.option.comment.length:0,!e.compressed)switch(e.crc32=t.calc(e.buffer),e.option.compressionMethod){case Zip.CompressionMethod.STORE:break;case Zip.CompressionMethod.DEFLATE:e.buffer=this.deflateWithOption(e.buffer,e.option),e.compressed=!0;break;default:throw new Error("unknown compression method:"+e.option.compressionMethod)}if(void 0!==e.option.password||void 0!==this.password){for(E=this.createEncryptionKey(e.option.password||this.password),F=e.buffer,(M=new Uint8Array(F.length+12)).set(F,12),F=M,D=0;D<12;++D)F[D]=this.encode(E,11===b?255&e.crc32:256*Math.random()|0);for(O=F.length;D<O;++D)F[D]=this.encode(E,F[D]);e.buffer=F}T+=30+u+e.buffer.length,A+=46+u+Z}for(s=22+(this.comment?this.comment.length:0),o=new Uint8Array(T+A+s),i=0,r=(n=T)+A,b=0,C=H.length;b<C;++b)u=(e=H[b]).option.filename?e.option.filename.length:0,g=0,Z=e.option.comment?e.option.comment.length:0,p=i,o[i++]=Zip.LocalFileHeaderSignature[0],o[i++]=Zip.LocalFileHeaderSignature[1],o[i++]=Zip.LocalFileHeaderSignature[2],o[i++]=Zip.LocalFileHeaderSignature[3],o[n++]=Zip.FileHeaderSignature[0],o[n++]=Zip.FileHeaderSignature[1],o[n++]=Zip.FileHeaderSignature[2],o[n++]=Zip.FileHeaderSignature[3],a=20,o[n++]=255&a,o[n++]=e.option.os||Zip.OperatingSystem.MSDOS,o[i++]=o[n++]=255&a,o[i++]=o[n++]=a>>8&255,c=0,(e.option.password||this.password)&&(c|=Zip.Flags.ENCRYPT),o[i++]=o[n++]=255&c,o[i++]=o[n++]=c>>8&255,h=e.option.compressionMethod,o[i++]=o[n++]=255&h,o[i++]=o[n++]=h>>8&255,l=e.option.date||new Date,o[i++]=o[n++]=(7&l.getMinutes())<<5|l.getSeconds()/2|0,o[i++]=o[n++]=l.getHours()<<3|l.getMinutes()>>3,o[i++]=o[n++]=(l.getMonth()+1&7)<<5|l.getDate(),o[i++]=o[n++]=(l.getFullYear()-1980&127)<<1|l.getMonth()+1>>3,d=e.crc32,o[i++]=o[n++]=255&d,o[i++]=o[n++]=d>>8&255,o[i++]=o[n++]=d>>16&255,o[i++]=o[n++]=d>>24&255,m=e.buffer.length,o[i++]=o[n++]=255&m,o[i++]=o[n++]=m>>8&255,o[i++]=o[n++]=m>>16&255,o[i++]=o[n++]=m>>24&255,f=e.size,o[i++]=o[n++]=255&f,o[i++]=o[n++]=f>>8&255,o[i++]=o[n++]=f>>16&255,o[i++]=o[n++]=f>>24&255,o[i++]=o[n++]=255&u,o[i++]=o[n++]=u>>8&255,o[i++]=o[n++]=255&g,o[i++]=o[n++]=g>>8&255,o[n++]=255&Z,o[n++]=Z>>8&255,o[n++]=0,o[n++]=0,o[n++]=0,o[n++]=0,o[n++]=0,o[n++]=0,o[n++]=0,o[n++]=0,o[n++]=255&p,o[n++]=p>>8&255,o[n++]=p>>16&255,o[n++]=p>>24&255,(y=e.option.filename)&&(o.set(y,i),o.set(y,n),i+=u,n+=u),(S=e.option.extraField)&&(o.set(S,i),o.set(S,n),i+=g,n+=g),(w=e.option.comment)&&(o.set(w,n),n+=Z),o.set(e.buffer,i),i+=e.buffer.length;return o[r++]=Zip.CentralDirectorySignature[0],o[r++]=Zip.CentralDirectorySignature[1],o[r++]=Zip.CentralDirectorySignature[2],o[r++]=Zip.CentralDirectorySignature[3],o[r++]=0,o[r++]=0,o[r++]=0,o[r++]=0,o[r++]=255&C,o[r++]=C>>8&255,o[r++]=255&C,o[r++]=C>>8&255,o[r++]=255&A,o[r++]=A>>8&255,o[r++]=A>>16&255,o[r++]=A>>24&255,o[r++]=255&T,o[r++]=T>>8&255,o[r++]=T>>16&255,o[r++]=T>>24&255,Z=this.comment?this.comment.length:0,o[r++]=255&Z,o[r++]=Z>>8&255,this.comment&&(o.set(this.comment,r),r+=Z),o},Zip.prototype.deflateWithOption=function(e,t){return new o(e,t.deflateOption).compress()},Zip.prototype.getByte=function(e){var t=65535&e[2]|2;return t*(1^t)>>8&255},Zip.prototype.encode=function(e,t){var o=this.getByte(e);return this.updateKeys(e,t),o^t},Zip.prototype.updateKeys=function(e,o){e[0]=t.single(e[0],o),e[1]=1+(6681*(20173*(e[1]+(255&e[0]))>>>0)>>>0)>>>0,e[2]=t.single(e[2],e[1]>>>24)},Zip.prototype.createEncryptionKey=function(e){var t,o,i=[305419896,591751049,878082192];for(i=new Uint32Array(i),t=0,o=e.length;t<o;++t)this.updateKeys(i,255&e[t]);return i},e.Zip=Zip});
//# sourceMappingURL=sourcemaps/Zip.js.map
